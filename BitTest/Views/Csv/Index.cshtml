@model IEnumerable<BitTest.Models.CsvRecord>

@{
    ViewData["Title"] = "CSV Records";
}

<link href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js" defer></script>

<h2>CSV Records</h2>

@if (!Model.Any())
{
    <p>No records found.</p>
}
else
{
    <table id="csvTable" class="display" style="width: 100%; border-collapse: collapse;">
        <thead>
            <tr>
                <th>Name</th>
                <th>Date of Birth</th>
                <th>Married</th>
                <th>Phone</th>
                <th>Salary</th>
                <th>Actions</th> 
            </tr>
        </thead>
        <tbody>
            @foreach (var record in Model)
            {
                <tr data-id="@record.Id">
                    <td contenteditable="true" class="editable" data-column="Name">@record.Name</td>
                    @{
                        var dateOfBirth = record.DateOfBirth.ToString("yyyy-MM-dd"); 
                    }
                    <td>
                        <input type="date" class="editable-date" data-column="DateOfBirth" value="@dateOfBirth" />
                    </td>
                    <td>
                        <select class="married-selector" data-id="@record.Id">
                            <option value="@record.Married">Yes</option>
                            <option value="@record.Married">No</option>
                        </select>
                    </td>
                    <td contenteditable="true" class="editable" data-column="Phone">@record.Phone</td>
                    <td contenteditable="true" class="editable" data-column="Salary">@record.Salary.ToString("C")</td>
                    <td>
                        <button class="delete-btn" data-id="@record.Id">Delete</button> 
                    </td>
                </tr>
            }
        </tbody>
    </table>
    <script>
        $(document).ready(function () {
            const table = $('#csvTable').DataTable({
                "paging": true,
                "searching": true,
                "ordering": true,
                "info": true,
                "lengthMenu": [10, 25, 50, 100],
                "order": [[1, 'asc']]
            });

            $('#csvTable').on('change', '.married-selector', function () {
                let selector = $(this);
                let recordId = selector.data('id');
                let newValue = selector.val(); 

                $.ajax({
                    url: '/Csv/Update', 
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        Id: recordId,
                        Column: "Married",
                        Value: newValue
                    }),
                    success: function () {
                        alert('Married status updated successfully.');
                    },
                    error: function (xhr) {
                        alert(`Error updating married status: ${xhr.responseText || "An unknown error occurred."}`);
                        selector.val(selector.data('originalValue'));
                    },
                    beforeSend: function () {
                        selector.data('originalValue', selector.val());
                    }
                });
            });

            $('#csvTable').on('change', '.editable-date', function () {
                let input = $(this);
                let recordId = input.closest('tr').data('id');
                let newValue = input.val();

                $.ajax({
                    url: '/Csv/Update', 
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        Id: recordId,
                        Column: "DateOfBirth",
                        Value: newValue
                    }),
                    success: function () {
                        console.log('Date of Birth updated successfully.');
                    },
                    error: function (xhr) {
                        alert(`Error updating Date of Birth: ${xhr.responseText || "An unknown error occurred."}`);
                    }
                });
            });

            $('#csvTable').on('blur', '.editable', function () {
                let cell = $(this);
                let row = cell.closest('tr');
                let recordId = row.data('id');
                let column = cell.data('column');
                let newValue = cell.text();

                $.ajax({
                    url: '/Csv/Update',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        Id: recordId,
                        Column: column,
                        Value: newValue
                    }),
                    success: function () {
                        console.log('Record updated successfully.');
                    },
                    error: function (xhr) {
                        try {
                            let response = JSON.parse(xhr.responseText);
                            let errorMessage = response.error || "An unknown error occurred.";
                            let originalValue = response.originalValue || cell.data('originalValue');
                            alert(`Error updating record: ${errorMessage}`);
                            cell.text(originalValue);
                        } catch (e) {
                            alert(`Error updating record: ${xhr.responseText || "An unknown error occurred."}`);
                            cell.text(cell.data('originalValue'));
                        }
                    },
                    beforeSend: function () {
                        cell.data('originalValue', cell.text());
                    }
                });
            });

            $('#csvTable').on('click', '.delete-btn', function () {
                let button = $(this);
                let recordId = button.data('id');
                let row = button.closest('tr');

                if (confirm('Are you sure you want to delete this record?')) {
                    $.ajax({
                        url: '/Csv/Delete',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({ Id: recordId }),
                        success: function () {
                            alert('Record deleted successfully.');
                            table.row(row).remove().draw();
                        },
                        error: function (xhr) {
                            alert(`Error deleting record: ${xhr.responseText || "An unknown error occurred."}`);
                        }
                    });
                }
            });
        });
    </script>
}
